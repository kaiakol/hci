<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PastaTimer</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <a class="logo">üçù PastaTimer</a>
      <select id="pastaDropdown">
        <option value="">Timers</option>
      </select>
      <div class="auth-buttons">
        <button id="loginBtn">Login</button>
        <button id="logoutBtn" style="display: none">Logout</button>
      </div>
    </header>

    <main>
      <section class="hero">
        <div style="display: flex; align-items: center; gap: 1rem">
          <div id="pastaPhoto" class="pasta-image" style="display: none">
            <img id="pastaImg" src="" alt="" />
          </div>
          <h1 id="title">PastaTimer</h1>
        </div>
        <p class="subtitle" id="subtitle">
          Perfect pasta, every time. Scan your tag, cook it right.
          <br />
          Log in to use personal length timer.
        </p>
      </section>

      <section class="timer-section">
        <div class="timer-container">
          <button id="minusBtn" aria-label="Subtract 30 seconds">‚àí</button>
          <svg id="progressCircle" width="140" height="140">
            <circle
              cx="70"
              cy="70"
              r="60"
              stroke="#e0e0e0"
              stroke-width="10"
              fill="none"
            />
            <circle
              id="progressBar"
              cx="70"
              cy="70"
              r="60"
              stroke="#FF6B6B"
              stroke-width="10"
              fill="none"
              stroke-linecap="round"
              stroke-dasharray="377"
              stroke-dashoffset="377"
              transform="rotate(-90 70 70)"
            />
          </svg>
          <button id="plusBtn" aria-label="Add 30 seconds">+</button>
          <div id="timer">--:--</div>
        </div>
        <div class="buttons">
          <button id="pausePlayBtn" style="display: none">||</button>
          <button id="restartBtn" style="display: none">‚Üª</button>
        </div>
        <button
          id="editTimersLink"
          onclick="window.location.href='edit.html'"
          style="width: 8rem"
        >
          Edit Timers
        </button>
      </section>
    </main>

    <footer>
      <p>Made with ‚ù§Ô∏è for pasta lovers</p>
      <a href="https://github.com/aiman01nad/aiman01nad.github.io"
        >View on GitHub</a
      >
    </footer>

    <audio id="doneSound" src="media/ding.mp3" preload="auto"></audio>

    <script src="script.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
      import {
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDwCr7eaBZ9LS-ZAiE6cjpAlg4txN7ares",
        authDomain: "pastatimer-25.firebaseapp.com",
        projectId: "pastatimer-25",
        storageBucket: "pastatimer-25.firebasestorage.app",
        messagingSenderId: "889344281638",
        appId: "1:889344281638:web:883c830c9bc55753d1aae7",
        measurementId: "G-DBSR4R4B0Y",
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
      window.firebaseAuth = auth;

      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const userEmail = document.getElementById("userEmail");
      const editTimersLink = document.getElementById("editTimersLink");

      loginBtn.onclick = () => {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider);
      };

      logoutBtn.onclick = () => {
        signOut(auth);
      };

      async function fetchPastaKeys(userId) {
        let url;
        if (userId) {
          url = `https://firestore.googleapis.com/v1/projects/pastatimer-25/databases/(default)/documents/user_timers/${userId}`;
        } else {
          url =
            "https://firestore.googleapis.com/v1/projects/pastatimer-25/databases/(default)/documents/timers/pasta";
        }
        const res = await fetch(url);
        const json = await res.json();
        const fields = json.fields || {};
        return Object.keys(fields);
      }

      async function populateDropdown(userId) {
        const dropdown = document.getElementById("pastaDropdown");
        if (!dropdown) return;
        dropdown.innerHTML = `<option value="">Timers</option>`;
        let keys = await fetchPastaKeys(userId);
        keys = keys.sort((a, b) =>
          a.localeCompare(b, undefined, { sensitivity: "base" })
        );
        keys.forEach((key) => {
          const opt = document.createElement("option");
          opt.value = key.toLowerCase();
          opt.textContent = key.charAt(0).toUpperCase() + key.slice(1);
          dropdown.appendChild(opt);
        });
        dropdown.onchange = function () {
          if (this.value) {
            window.location.href = `index.html?timer=${this.value}`;
          }
        };
      }

      onAuthStateChanged(auth, async (user) => {
        const params = new URLSearchParams(window.location.search);
        const timer = params.get("timer");
        const subtitle = document.getElementById("subtitle");
        if (user) {
          await populateDropdown(user.uid);
          loginBtn.style.display = "none";
          logoutBtn.style.display = "inline-block";
          const pastaMap = await fetchPastaMap(user.uid);
          subtitle.innerHTML = `Perfect pasta, every time. Scan your tag, cook it right.<br />Log out to use standard time.`;
          if (editTimersLink) editTimersLink.style.display = "inline";
          if (timer && pastaMap[timer.toLowerCase()]) {
            startTimer(timer, pastaMap[timer.toLowerCase()]);
            showPastaImage(timer.toLowerCase());
          }
        } else {
          await populateDropdown(null);
          loginBtn.style.display = "inline-block";
          logoutBtn.style.display = "none";
          const pastaMap = await fetchPastaMap(null);
          subtitle.innerHTML = `Perfect pasta, every time. Scan your tag, cook it right.<br />Log in to use personal length timer.`;
          if (editTimersLink) editTimersLink.style.display = "none";
          if (timer && pastaMap[timer.toLowerCase()]) {
            startTimer(timer, pastaMap[timer.toLowerCase()]);
            showPastaImage(timer.toLowerCase());
          }
        }
      });

      function showPastaImage(pastaName) {
        const img = document.getElementById("pastaImg");
        const container = document.getElementById("pastaPhoto");
        img.src = `images/${pastaName.toLowerCase()}.svg`;
        container.style.display = "block";
      }

      window.addEventListener("load", () => {
        const params = new URLSearchParams(window.location.search);
        const timer = params.get("timer");
        if (timer) {
          showPastaImage(timer);
        }
      });
    </script>
  </body>
</html>
